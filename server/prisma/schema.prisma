// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id                String      @id @default(cuid())
  email             String      @unique
  firstName         String
  lastName          String
  password          String
  role              UserRole    @default(CUSTOMER)
  avatar            String?
  phoneNumber       String?
  isEmailVerified   Boolean     @default(false)
  isActive          Boolean     @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?

  // Relations
  addresses         Address[]
  orders            Order[]
  reviews           Review[]
  cartItems         CartItem[]

  @@index([email])
  @@index([role])
}

// Product Model
model Product {
  id                String      @id @default(cuid())
  name              String      @db.VarChar(255)
  description       String      @db.Text
  shortDescription  String?     @db.VarChar(500)
  price             Decimal     @db.Decimal(10, 2)
  discountPrice     Decimal?    @db.Decimal(10, 2)
  sku               String      @unique
  stock             Int         @default(0)
  images            String[]
  featured          Boolean     @default(false)
  active            Boolean     @default(true)
  rating            Decimal     @default(0) @db.Decimal(3, 2)
  reviewCount       Int         @default(0)
  viewCount         Int         @default(0)
  categoryId        String
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?

  // Relations
  category          Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  variants          ProductVariant[]
  reviews           Review[]
  orderItems        OrderItem[]
  cartItems         CartItem[]

  @@index([categoryId])
  @@index([sku])
  @@index([featured])
  @@index([active])
}

// Product Variant Model
model ProductVariant {
  id                String      @id @default(cuid())
  productId         String
  name              String
  value             String
  sku               String      @unique
  stock             Int         @default(0)
  priceModifier     Decimal?    @db.Decimal(10, 2)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems         CartItem[]
  orderItems        OrderItem[]

  @@index([productId])
  @@index([sku])
}

// Category Model
model Category {
  id                String      @id @default(cuid())
  name              String      @unique
  slug              String      @unique
  description       String?     @db.Text
  image             String?
  parentId          String?
  active            Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  products          Product[]
  parent            Category?   @relation("ParentChild", fields: [parentId], references: [id], onDelete: SetNull)
  children          Category[]  @relation("ParentChild")

  @@index([slug])
  @@index([parentId])
}

// Order Model
model Order {
  id                String      @id @default(cuid())
  userId            String
  orderNumber       String      @unique
  status            OrderStatus @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  totalAmount       Decimal     @db.Decimal(10, 2)
  subtotal          Decimal     @db.Decimal(10, 2)
  tax               Decimal     @db.Decimal(10, 2)
  shippingCost      Decimal     @db.Decimal(10, 2)
  discountAmount    Decimal     @default(0) @db.Decimal(10, 2)
  shippingAddressId String
  notes             String?     @db.Text
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  paidAt            DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items             OrderItem[]
  shippingAddress   Address     @relation(fields: [shippingAddressId], references: [id])
  payment           Payment?

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderNumber])
}

// Order Item Model
model OrderItem {
  id                String      @id @default(cuid())
  orderId           String
  productId         String
  variantId         String?
  quantity          Int
  price             Decimal     @db.Decimal(10, 2)
  subtotal          Decimal     @db.Decimal(10, 2)

  // Relations
  order             Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product           Product     @relation(fields: [productId], references: [id])
  variant           ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

// Cart Item Model
model CartItem {
  id                String      @id @default(cuid())
  userId            String
  productId         String
  variantId         String?
  quantity          Int
  addedAt           DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant           ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([productId])
}

// Review Model
model Review {
  id                String      @id @default(cuid())
  productId         String
  userId            String
  rating            Int         // 1-5
  title             String      @db.VarChar(200)
  content           String      @db.Text
  verified          Boolean     @default(false)
  helpful           Int         @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([rating])
}

// Address Model
model Address {
  id                String      @id @default(cuid())
  userId            String
  name              String
  street            String
  city              String
  state             String
  postalCode        String
  country           String
  phoneNumber       String?
  isDefault         Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders            Order[]

  @@index([userId])
}

// Payment Model
model Payment {
  id                String      @id @default(cuid())
  orderId           String      @unique
  amount            Decimal     @db.Decimal(10, 2)
  currency          String      @default("USD")
  status            PaymentStatus @default(PENDING)
  method            PaymentMethod
  stripePaymentId   String?     @unique
  transactionId     String?     @unique
  errorMessage      String?     @db.Text
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  processedAt       DateTime?

  // Relations
  order             Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([stripePaymentId])
  @@index([status])
}

// Enums
enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  BANK_TRANSFER
}
